{% extends "base.html" %}

{% block title %}Panel de administraci√≥n{% endblock %}

{% block content %}
<style>
  :root {
    --mp-surface: #fff;
    --mp-muted: #6c757d;
    --mp-border: rgba(0, 0, 0, .1);
    --mp-shadow: 0 8px 24px rgba(0, 0, 0, .06);
  }

  .admin-wrap {
    background: linear-gradient(180deg, rgba(13, 110, 253, .05), transparent 60%);
    padding: 18px;
    border-radius: 10px;
  }

  .admin-card {
    background: var(--mp-surface);
    border: 1px solid var(--mp-border);
    border-radius: 10px;
    box-shadow: var(--mp-shadow);
  }

  .admin-card .card-header {
    background: rgba(0, 0, 0, .03);
    border-bottom: 1px solid var(--mp-border);
    font-weight: 700;
  }

  .admin-subtitle { color: var(--mp-muted); }

  /* ===== Botones ===== */
  .btn-mp {
    border-radius: 8px;
    padding: .45rem .8rem;
    border: 1px solid rgba(0, 0, 0, .12);
    background: #fff;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0, 0, 0, .05);
  }
  .btn-mp.primary { background: rgba(13, 110, 253, .08); }
  .btn-mp.success { background: rgba(25, 135, 84, .12); }
  .btn-mp.warning { background: rgba(255, 193, 7, .22); }
  .btn-mp.neutral { background: rgba(108, 117, 125, .08); }

  /* ===== CAT√ÅLOGO ===== */
  .catalog-toolbar { display: grid; gap: .75rem; }

  .tech-tabs { display: flex; flex-wrap: wrap; gap: .5rem; }

  .tech-tab {
    display: flex;
    align-items: center;
    gap: .45rem;
    padding: .45rem .7rem;
    border: 1px solid rgba(0, 0, 0, .12);
    border-radius: 8px;
    background: #fff;
    color: #111;
    text-decoration: none;
    font-weight: 600;
  }

  .tech-tab.active {
    border-color: rgba(13, 110, 253, .4);
    background: rgba(13, 110, 253, .08);
  }

  .dot { width: 10px; height: 10px; border-radius: 3px; display: inline-block; }
  .dot-all { background: #0d6efd; }
  .dot-sub { background: #dc3545; }
  .dot-las { background: #ffc107; }
  .dot-3d { background: #198754; }
  .dot-otr { background: #6c757d; }

  .order-box { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
  .order-label { font-size: .9rem; color: rgba(0, 0, 0, .65); font-weight: 600; }

  .row-inactive { opacity: .7; }

  .badge-soft {
    background: rgba(0, 0, 0, .05);
    color: #333;
    border: 1px solid rgba(0, 0, 0, .08);
  }
</style>

<div class="container-fluid my-4">
  <div class="admin-wrap">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
      <div>
        <h1 class="h4 mb-1">Panel de administraci√≥n</h1>
        <p class="admin-subtitle mb-0">Gesti√≥n de cat√°logo, precios y facturaci√≥n</p>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-mp neutral" href="{% url 'home' %}">üîÑ Refrescar</a>
        <a class="btn btn-mp primary" href="{% url 'catalogo' %}" target="_blank">üõçÔ∏è Cat√°logo p√∫blico</a>
      </div>
    </div>

    <!-- ACCIONES -->
    <div class="card admin-card mb-3">
      <div class="card-body d-flex flex-wrap gap-2">
        <a class="btn btn-mp primary" href="{% url 'importar_pdf' %}">üì• Importar PDF</a>
        <a class="btn btn-mp primary" href="{% url 'procesar_factura' %}">üßæ Procesar factura</a>
        <a class="btn btn-mp neutral" href="{% url 'historia_listas' %}">üìö Historia</a>
        <a class="btn btn-mp warning" href="{% url 'owner_cupon_list' %}">üéüÔ∏è Cupones</a>
        <a class="btn btn-mp success" href="{% url 'owner_oferta_list' %}">üí∏ Ofertas</a>
        <a class="btn btn-mp primary" href="{% url 'owner_producto_create_ui' %}">‚ûï Nuevo art√≠culo</a>
        <a class="btn btn-mp neutral" href="{% url 'lista_precios_opciones' %}">üìÑ Lista PDF</a>
        <a class="btn btn-mp primary" href="{% url 'factura_crear' %}">üßæ Generar factura</a>
        <a class="btn btn-mp primary" href="{% url 'owner_autorubros' %}">üßæ Auto-Rubros</a>
        <a class="btn btn-mp neutral" href="{% url 'owner_filtros_panel' %}">üß© Filtros de cat√°logo</a>
        <a class="btn btn-mp primary" href="{% url 'owner_siteinfo_list' %}">üìù Informaci√≥n del sitio</a>
      </div>
    </div>

    <!-- CAT√ÅLOGO -->
    <div class="card admin-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        Cat√°logo de precios
        <span class="badge bg-primary">{{ total_productos_precio|default:0 }} productos</span>
      </div>

      <div class="card-body">

        <!-- BUSCADOR -->
        <form class="mb-3" method="get">
          <div class="input-group">
            <input class="form-control" name="q" value="{{ q }}" placeholder="Buscar por SKU o nombre p√∫blico">
            <button class="btn btn-mp neutral">Buscar</button>
          </div>
        </form>

        <div class="catalog-toolbar">

          <!-- FILTROS POR T√âCNICA -->
          {% with tl=t|default:''|lower %}
          <div class="tech-tabs">
            <a class="tech-tab {% if not tl %}active{% endif %}" href="?">
              <span class="dot dot-all"></span> Todo
            </a>

            <a class="tech-tab {% if tl == 'sub' %}active{% endif %}" href="?t=sub">
              <span class="dot dot-sub"></span> Sublimaci√≥n
            </a>

            <a class="tech-tab {% if tl == 'laser' %}active{% endif %}" href="?t=laser">
              <span class="dot dot-las"></span> L√°ser
            </a>

            <a class="tech-tab {% if tl == '3d' %}active{% endif %}" href="?t=3d">
              <span class="dot dot-3d"></span> 3D
            </a>

            <a class="tech-tab {% if tl == 'otr' %}active{% endif %}" href="?t=otr">
              <span class="dot dot-otr"></span> Otro
            </a>
          </div>
          {% endwith %}

          <!-- ORDEN + INACTIVOS -->
          <div class="order-box">
            <span class="order-label">Orden:</span>
            <form method="get" class="d-flex gap-2 align-items-center flex-wrap">
              <input type="hidden" name="q" value="{{ q }}">
              <input type="hidden" name="t" value="{{ t }}">
              <select name="o" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="">Nombre</option>
                <option value="recientes" {% if o == 'recientes' %}selected{% endif %}>M√°s recientes</option>
                <option value="antiguos" {% if o == 'antiguos' %}selected{% endif %}>M√°s antiguos</option>
                <option value="precio_desc" {% if o == 'precio_desc' %}selected{% endif %}>Mayor precio</option>
                <option value="precio_asc" {% if o == 'precio_asc' %}selected{% endif %}>Menor precio</option>
              </select>

              <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" name="show_inactive" value="1" {% if show_inactive %}checked{% endif %} onchange="this.form.submit()">
                <label class="form-check-label text-muted">Mostrar inactivos</label>
              </div>
            </form>
          </div>

        </div>

        <!-- TABLA + ACCIONES MASIVAS -->
        <div class="table-responsive mt-3">
          <form method="post" id="bulkForm">
            {% csrf_token %}

            <!-- Barra de acciones masivas -->
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
              <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" id="selectAllTop" onclick="toggleSelectAll(this)">
                <label class="form-check-label small" for="selectAllTop">Seleccionar todos</label>
              </div>

              <div class="d-flex gap-2 align-items-center flex-wrap">
                <select name="bulkAccion" id="bulkAccion" class="form-select form-select-sm" onchange="toggleBulkTech()">
                  <option value="">Acci√≥n masiva...</option>
                  <option value="activar">Dar de alta seleccionados</option>
                  <option value="desactivar">Dar de baja seleccionados</option>
                  <option value="eliminar">Eliminar seleccionados</option>
                  <option value="set_tech">Asignar t√©cnica (tech)</option>
                </select>

                <!-- aparece solo si bulkAccion == set_tech -->
                <select name="bulkTech" id="bulkTech" class="form-select form-select-sm" style="display:none; min-width: 180px;">
                  <option value="">Elegir t√©cnica...</option>
                  <option value="SUB">Sublimaci√≥n</option>
                  <option value="LAS">Grabado l√°ser</option>
                  <option value="3D">Impresi√≥n 3D</option>
                  <option value="OTR">Otro</option>
                </select>

                <button type="submit" class="btn btn-sm btn-danger">
                  Aplicar
                </button>
              </div>
            </div>

            <table class="table table-hover table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width:32px;">
                    <input class="form-check-input" type="checkbox" onclick="toggleSelectAll(this)">
                  </th>
                  <th>SKU</th>
                  <th>Nombre p√∫blico</th>
                  <th class="text-center">T√©cnica</th>
                  <th class="text-center">Stock</th>
                  <th class="text-end">Precio</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for p in products %}
                <tr class="{% if not p.activo %}row-inactive table-secondary{% endif %}">
                  <td>
                    <input
                      type="checkbox"
                      class="form-check-input chk-producto"
                      name="ids"
                      value="{{ p.id }}"
                    >
                  </td>
                  <td class="small">{{ p.sku }}</td>
                  <td class="fw-semibold">{{ p.nombre_publico }}</td>
                  <td class="text-center">
                    <span class="badge badge-soft">
                      {% if p.tech == 'SUB' %}Sublimaci√≥n
                      {% elif p.tech == 'LAS' %}L√°ser
                      {% elif p.tech == '3D' %}3D
                      {% else %}Otro{% endif %}
                    </span>
                  </td>
                  <td class="text-center">{{ p.stock }}</td>
                  <td class="text-end fw-bold">$ {{ p.precio|floatformat:2 }}</td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-mp primary" href="{% url 'owner_producto_editar' p.id %}">
                      Editar
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">
                    No hay productos para mostrar
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </form>
        </div>

      </div>
    </div>

  </div>
</div>

<script>
  // Seleccionar / deseleccionar todos
  function toggleSelectAll(source) {
    document.querySelectorAll('.chk-producto').forEach(ch => ch.checked = source.checked);
  }

  // Mostrar/ocultar selector de t√©cnica seg√∫n la acci√≥n elegida
  function toggleBulkTech() {
    const accion = document.getElementById("bulkAccion");
    const techSel = document.getElementById("bulkTech");
    if (!accion || !techSel) return;

    if (accion.value === "set_tech") {
      techSel.style.display = "block";
    } else {
      techSel.style.display = "none";
      techSel.value = "";
    }
  }

  // asegurar estado correcto al cargar (por si el navegador recuerda el select)
  document.addEventListener("DOMContentLoaded", toggleBulkTech);

  // --- Ir a editar producto (typeahead + redirect) ---
  const gotoQ = document.getElementById("gotoEditQ");
  const gotoBtn = document.getElementById("gotoEditBtn");
  const gotoTA = document.getElementById("gotoEditTypeahead");

  if (gotoQ && gotoBtn && gotoTA) {
    let gotoTimer = null;
    let gotoIndex = -1;

    function gotoHide() {
      gotoTA.style.display = "none";
      gotoTA.innerHTML = "";
      gotoIndex = -1;
    }

    function gotoShow(items) {
      gotoTA.innerHTML = "";
      if (!items.length) {
        const div = document.createElement("div");
        div.className = "dropdown-item text-muted";
        div.textContent = "Sin resultados";
        gotoTA.appendChild(div);
      } else {
        items.forEach((p) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "dropdown-item";
          btn.innerHTML = `<strong>${p.sku}</strong> ‚Äî ${p.nombre_publico}
                           <span class="badge rounded-pill badge-soft ms-2">$ ${p.precio}</span>`;
          btn.addEventListener("click", () => {
            window.location.href = `{% url 'owner_producto_editar' 0 %}`.replace("/0/", `/${p.id}/`);
          });
          gotoTA.appendChild(btn);
        });
      }
      gotoTA.style.display = "block";
      gotoIndex = -1;
    }

    function gotoMove(delta) {
      const items = Array.from(gotoTA.querySelectorAll(".dropdown-item"));
      if (!items.length) return;
      gotoIndex = Math.max(0, Math.min(items.length - 1, gotoIndex + delta));
      items.forEach((el, i) => el.classList.toggle("active", i === gotoIndex));
      items[gotoIndex].scrollIntoView({ block: "nearest" });
    }

    function gotoPick() {
      const items = Array.from(gotoTA.querySelectorAll(".dropdown-item"));
      if (gotoIndex >= 0 && gotoIndex < items.length) items[gotoIndex].click();
    }

    async function gotoSuggest(term) {
      const r = await fetch(`{% url 'owner_api_product_suggest' %}?q=${encodeURIComponent(term)}`);
      if (!r.ok) return { results: [] };
      return r.json();
    }

    gotoQ.addEventListener("input", () => {
      const term = gotoQ.value.trim();
      if (gotoTimer) clearTimeout(gotoTimer);
      if (!term) { gotoHide(); return; }

      gotoTimer = setTimeout(async () => {
        try {
          const data = await gotoSuggest(term);
          gotoShow(data.results || []);
        } catch {
          gotoTA.innerHTML = '<div class="dropdown-item text-danger">Error buscando</div>';
          gotoTA.style.display = "block";
        }
      }, 200);
    });

    gotoQ.addEventListener("keydown", (e) => {
      if (gotoTA.style.display !== "block") return;
      if (e.key === "ArrowDown") { e.preventDefault(); gotoMove(1); }
      else if (e.key === "ArrowUp") { e.preventDefault(); gotoMove(-1); }
      else if (e.key === "Enter") { e.preventDefault(); gotoPick(); }
      else if (e.key === "Escape") { gotoHide(); }
    });

    gotoQ.addEventListener("blur", () => setTimeout(gotoHide, 150));

    gotoBtn.addEventListener("click", () => {
      const term = gotoQ.value.trim();
      if (!term) return;
      gotoQ.dispatchEvent(new Event("input"));
    });
  }
</script>
{% endblock %}
