{% extends "base.html" %}

{% block title %}Panel de administraci√≥n{% endblock %}

{% block content %}
<div class="container-fluid my-4">

  <!-- Encabezado general -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h4 mb-1">Panel de administraci√≥n</h1>
      <p class="text-muted mb-0">
        Solo visible para due√±o/admin. Ac√° manej√°s cat√°logo, listas de precios y facturas.
      </p>
    </div>
  </div>

  <!-- ACCIONES R√ÅPIDAS (todo lo admin ac√°, texto negro) -->
  <div class="card mb-3 shadow-sm border-0">
    <div class="card-body py-2">

      <!-- ATAJO: Ir a editar producto -->
      <div class="position-relative mb-2">
        <div class="input-group input-group-sm">
          <span class="input-group-text">‚úèÔ∏è Editar producto</span>
          <input id="gotoEditQ" type="text" class="form-control" placeholder="Escrib√≠ SKU o nombre‚Ä¶">
          <button id="gotoEditBtn" type="button" class="btn btn-outline-dark">Ir</button>
        </div>

        <div id="gotoEditTypeahead" class="dropdown-menu w-100 p-0 mt-1"
          style="display:none; max-height:280px; overflow:auto;">
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2">

        <!-- ‚úÖ dejamos solo UNO -->
        <a class="btn btn-sm btn-outline-secondary text-dark" href="{% url 'ver_catalogo_completo' %}" target="_blank">
          üõçÔ∏è Cat√°logo p√∫blico
        </a>

        <a class="btn btn-sm btn-outline-primary text-dark" href="{% url 'importar_pdf' %}">
          üì• Importar lista PDF
        </a>

        <a class="btn btn-sm btn-outline-primary text-dark" href="{% url 'procesar_factura' %}">
          üßæ Procesar factura
        </a>

        <a class="btn btn-sm btn-outline-primary text-dark" href="{% url 'historia_listas' %}">
          üìö Historia listas / ingresos
        </a>

        <a class="btn btn-sm btn-outline-warning text-dark" href="{% url 'owner_cupon_list' %}">
          üéüÔ∏è Cupones
        </a>

        <a class="btn btn-sm btn-outline-success text-dark" href="{% url 'owner_oferta_list' %}">
          üí∏ Ofertas
        </a>

        <a class="btn btn-sm btn-outline-info text-dark" href="{% url 'owner_producto_create_ui' %}">
          ‚ûï Nuevo art√≠culo
        </a>

        <a class="btn btn-sm btn-outline-secondary text-dark" href="{% url 'home' %}">
          üîÑ Refrescar
        </a>

        <a class="btn btn-sm btn-outline-primary text-dark" href="{% url 'descargar_lista_precios_pdf' %}"
          target="_blank">
          üìÑ Descargar lista de precios (PDF)
        </a>

      </div>

      <small class="text-muted d-block mt-2">
        Todo lo de admin est√° centralizado ac√°.
      </small>
    </div>
  </div>

  <!-- ========== CAT√ÅLOGO (ProductoPrecio) ========== -->
  <div class="card mb-3 shadow-sm border-0">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Cat√°logo de precios</span>
      <span class="badge bg-primary">
        {{ total_productos_precio|default:0 }} productos
      </span>
    </div>

    <div class="card-body">

      <!-- B√∫squeda -->
      <form class="mb-3" method="get">
        <div class="input-group">
          <input type="text" class="form-control" name="q" value="{{ q }}"
            placeholder="Buscar por SKU o nombre p√∫blico">
          {% if t %}<input type="hidden" name="t" value="{{ t }}">{% endif %}
          {% if o %}<input type="hidden" name="o" value="{{ o }}">{% endif %}
          {% if show_inactive %}<input type="hidden" name="show_inactive" value="1">{% endif %}
          <button class="btn btn-outline-secondary" type="submit">Buscar</button>
          {% if q or t or o or show_inactive %}
          <a class="btn btn-outline-light border" href="{% url 'home' %}">Limpiar</a>
          {% endif %}
        </div>
      </form>

      <!-- Filtros por t√©cnica -->
      {% with tl=t|default:''|lower %}
      <div class="d-flex flex-wrap gap-2 mb-2">
        <a class="btn btn-sm {% if not tl %}btn-primary{% else %}btn-outline-primary text-dark{% endif %}"
          href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if o %}o={{ o }}&{% endif %}{% if show_inactive %}show_inactive=1{% endif %}">
          Todo
        </a>

        <a class="btn btn-sm {% if tl == 'sub' %}btn-primary{% else %}btn-outline-primary text-dark{% endif %}"
          href="?{% if q %}q={{ q|urlencode }}&{% endif %}t=sub{% if o %}&o={{ o }}{% endif %}{% if show_inactive %}&show_inactive=1{% endif %}">
          Sublimaci√≥n
        </a>

        <a class="btn btn-sm {% if tl == 'laser' %}btn-primary{% else %}btn-outline-primary text-dark{% endif %}"
          href="?{% if q %}q={{ q|urlencode }}&{% endif %}t=laser{% if o %}&o={{ o }}{% endif %}{% if show_inactive %}&show_inactive=1{% endif %}">
          Grabado l√°ser
        </a>

        <a class="btn btn-sm {% if tl == '3d' %}btn-primary{% else %}btn-outline-primary text-dark{% endif %}"
          href="?{% if q %}q={{ q|urlencode }}&{% endif %}t=3d{% if o %}&o={{ o }}{% endif %}{% if show_inactive %}&show_inactive=1{% endif %}">
          Impresi√≥n 3D
        </a>

        <a class="btn btn-sm {% if tl == 'otr' %}btn-primary{% else %}btn-outline-primary text-dark{% endif %}"
          href="?{% if q %}q={{ q|urlencode }}&{% endif %}t=otr{% if o %}&o={{ o }}{% endif %}{% if show_inactive %}&show_inactive=1{% endif %}">
          Otro
        </a>
      </div>
      {% endwith %}

      <!-- ORDEN + INACTIVOS -->
      <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
        <div class="btn-group btn-group-sm">
          <a class="btn btn-outline-secondary {% if not o %}active{% endif %}"
            href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if t %}t={{ t }}&{% endif %}{% if show_inactive %}show_inactive=1{% endif %}">
            Nombre
          </a>
          <a class="btn btn-outline-secondary {% if o == 'recientes' %}active{% endif %}"
            href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if t %}t={{ t }}&{% endif %}o=recientes{% if show_inactive %}&show_inactive=1{% endif %}">
            M√°s recientes
          </a>
          <a class="btn btn-outline-secondary {% if o == 'antiguos' %}active{% endif %}"
            href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if t %}t={{ t }}&{% endif %}o=antiguos{% if show_inactive %}&show_inactive=1{% endif %}">
            M√°s antiguos
          </a>
          <a class="btn btn-outline-secondary {% if o == 'precio_desc' %}active{% endif %}"
            href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if t %}t={{ t }}&{% endif %}o=precio_desc{% if show_inactive %}&show_inactive=1{% endif %}">
            Mayor precio
          </a>
          <a class="btn btn-outline-secondary {% if o == 'precio_asc' %}active{% endif %}"
            href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if t %}t={{ t }}&{% endif %}o=precio_asc{% if show_inactive %}&show_inactive=1{% endif %}">
            Menor precio
          </a>
        </div>

        <form method="get" class="ms-auto d-flex align-items-center gap-2">
          <input type="hidden" name="q" value="{{ q }}">
          <input type="hidden" name="t" value="{{ t }}">
          <input type="hidden" name="o" value="{{ o }}">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="show_inactive" value="1" {% if show_inactive %}checked{% endif %} onchange="this.form.submit()">
            <label class="form-check-label">Mostrar inactivos</label>
          </div>
        </form>
      </div>

      <!-- FORM ACCIONES MASIVAS -->
      <form id="bulkForm" method="post" action="{% url 'owner_productos_acciones_masivas' %}">
        {% csrf_token %}
        <input type="hidden" name="accion" id="bulkAccion">

        <div class="table-responsive">
          <table class="table table-hover table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th><input type="checkbox" class="form-check-input" onclick="toggleSelectAll(this)"></th>
                <th>SKU</th>
                <th>Nombre p√∫blico</th>
                <th class="text-center">T√©cnica</th>
                <th class="text-center">Stock</th>
                <th class="text-end">Precio</th>
                <th>√öltima actualizaci√≥n</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for p in products %}
              <tr class="{% if not p.activo %}table-secondary{% endif %}">
                <td><input type="checkbox" class="form-check-input chk-producto" name="ids" value="{{ p.id }}"></td>
                <td class="small">{{ p.sku }}</td>
                <td>{{ p.nombre_publico }}</td>
                <td class="text-center">
                  <span class="badge text-bg-light">
                    {% if p.tech == 'SUB' %}Sublimaci√≥n{% elif p.tech == 'LAS' %}
                    L√°ser{% elif p.tech == '3D' %}3D{% else %}Otro{% endif %}
                  </span>
                </td>
                <td class="text-center">
                  <span class="badge {% if p.stock > 0 %}text-bg-success{% else %}text-bg-secondary{% endif %}">
                    {{ p.stock }}
                  </span>
                </td>
                <td class="text-end fw-semibold">$ {{ p.precio|floatformat:2 }}</td>
                <td class="small text-muted">{{ p.ultima_actualizacion|date:"d/m/Y H:i" }}</td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm">
                    <a class="btn btn-outline-primary text-dark"
                      href="{% url 'owner_producto_editar' p.id %}">Editar</a>
                    {% if p.activo %}
                    <button type="button" class="btn btn-outline-warning text-dark"
                      onclick="accionFila({{ p.id }}, 'baja')">Baja</button>
                    {% else %}
                    <button type="button" class="btn btn-outline-success text-dark"
                      onclick="accionFila({{ p.id }}, 'alta')">Alta</button>
                    {% endif %}
                    <button type="button" class="btn btn-outline-danger text-dark"
                      onclick="accionFila({{ p.id }}, 'eliminar')">Eliminar</button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted py-4">
                  No hay productos para mostrar con los filtros actuales.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </form>

    </div>
  </div>

</div>

<script>
  function toggleSelectAll(source) {
    document.querySelectorAll('.chk-producto').forEach(ch => ch.checked = source.checked);
  }

  function accionFila(id, accion) {
    document.querySelectorAll('.chk-producto').forEach(ch => ch.checked = false);
    const chk = document.querySelector('.chk-producto[value="' + id + '"]');
    if (chk) chk.checked = true;

    if (accion === 'eliminar' && !confirm('¬øEliminar definitivamente este producto?')) return;
    document.getElementById('bulkAccion').value = accion;
    document.getElementById('bulkForm').submit();
  }

  // --- Ir a editar producto (typeahead + redirect) ---
  const gotoQ = document.getElementById("gotoEditQ");
  const gotoBtn = document.getElementById("gotoEditBtn");
  const gotoTA = document.getElementById("gotoEditTypeahead");

  let gotoTimer = null;
  let gotoIndex = -1;

  function gotoHide() {
    gotoTA.style.display = "none";
    gotoTA.innerHTML = "";
    gotoIndex = -1;
  }

  function gotoShow(items) {
    gotoTA.innerHTML = "";
    if (!items.length) {
      const div = document.createElement("div");
      div.className = "dropdown-item text-muted";
      div.textContent = "Sin resultados";
      gotoTA.appendChild(div);
    } else {
      items.forEach((p) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "dropdown-item";
        btn.innerHTML = `<strong>${p.sku}</strong> ‚Äî ${p.nombre_publico}
                         <span class="badge text-bg-light ms-2">$ ${p.precio}</span>`;
        btn.addEventListener("click", () => {
          window.location.href = `{% url 'owner_producto_editar' 0 %}`.replace("/0/", `/${p.id}/`);
        });
        gotoTA.appendChild(btn);
      });
    }
    gotoTA.style.display = "block";
    gotoIndex = -1;
  }

  function gotoMove(delta) {
    const items = Array.from(gotoTA.querySelectorAll(".dropdown-item"));
    if (!items.length) return;
    gotoIndex = Math.max(0, Math.min(items.length - 1, gotoIndex + delta));
    items.forEach((el, i) => el.classList.toggle("active", i === gotoIndex));
    items[gotoIndex].scrollIntoView({ block: "nearest" });
  }

  function gotoPick() {
    const items = Array.from(gotoTA.querySelectorAll(".dropdown-item"));
    if (gotoIndex >= 0 && gotoIndex < items.length) items[gotoIndex].click();
  }

  async function gotoSuggest(term) {
    const r = await fetch(`{% url 'owner_api_product_suggest' %}?q=${encodeURIComponent(term)}`);
    if (!r.ok) return { results: [] };
    return r.json();
  }

  gotoQ.addEventListener("input", () => {
    const term = gotoQ.value.trim();
    if (gotoTimer) clearTimeout(gotoTimer);
    if (!term) { gotoHide(); return; }

    gotoTimer = setTimeout(async () => {
      try {
        const data = await gotoSuggest(term);
        gotoShow(data.results || []);
      } catch {
        gotoTA.innerHTML = '<div class="dropdown-item text-danger">Error buscando</div>';
        gotoTA.style.display = "block";
      }
    }, 200);
  });

  gotoQ.addEventListener("keydown", (e) => {
    if (gotoTA.style.display !== "block") return;
    if (e.key === "ArrowDown") { e.preventDefault(); gotoMove(1); }
    else if (e.key === "ArrowUp") { e.preventDefault(); gotoMove(-1); }
    else if (e.key === "Enter") { e.preventDefault(); gotoPick(); }
    else if (e.key === "Escape") { gotoHide(); }
  });

  gotoQ.addEventListener("blur", () => setTimeout(gotoHide, 150));

  gotoBtn.addEventListener("click", () => {
    const term = gotoQ.value.trim();
    if (!term) return;
    gotoQ.dispatchEvent(new Event("input"));
  });
</script>
{% endblock %}