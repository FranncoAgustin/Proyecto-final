{% extends "base.html" %}

{% block title %}Editar producto{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 mb-0">Editar producto</h1>
    <a href="{% url 'home' %}" class="btn btn-sm btn-outline-secondary">‚Üê Volver al panel</a>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body">

      <!-- ‚úÖ IMPORTANTE: enctype para archivos -->
      <form method="post" enctype="multipart/form-data" id="mainForm">
        {% csrf_token %}

        <!-- ACCIONES PELIGROSAS / R√ÅPIDAS -->
        <div class="d-flex flex-wrap gap-2 justify-content-end mb-3">
          <!-- Baja/Alta -->
          <button type="submit" name="action" value="toggle_active"
                  class="btn btn-sm {% if producto.activo %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
            {% if producto.activo %}üîª Dar de baja{% else %}‚úÖ Dar de alta{% endif %}
          </button>

          <!-- Eliminar producto -->
          <button type="submit" name="action" value="delete_product"
                  class="btn btn-sm btn-outline-danger"
                  onclick="return confirm('¬øEliminar definitivamente este producto? Esta acci√≥n no se puede deshacer.')">
            üóëÔ∏è Eliminar producto
          </button>
        </div>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">SKU</label>

            <div class="position-relative">
              <input id="id_sku" type="text" name="sku" class="form-control"
                     value="{{ producto.sku }}" autocomplete="off">

              <div id="skuTypeahead"
                   class="dropdown-menu w-100 p-0"
                   style="display:none; max-height:280px; overflow:auto;">
              </div>
            </div>

            <div class="form-text">
              Escrib√≠ para buscar productos (por SKU o nombre) y saltar directo a su edici√≥n.
            </div>
          </div>

          <div class="col-md-8">
            <label class="form-label">Nombre p√∫blico</label>
            <input type="text" name="nombre_publico" class="form-control" value="{{ producto.nombre_publico }}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Precio</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="text" name="precio" class="form-control" value="{{ producto.precio }}">
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Stock</label>
            <input type="number" name="stock" class="form-control" value="{{ producto.stock }}">
          </div>

          <div class="col-md-4">
            <label class="form-label">T√©cnica</label>
            <select name="tech" class="form-select">
              <option value="">(Sin especificar)</option>
              <option value="SUB" {% if producto.tech == "SUB" %}selected{% endif %}>Sublimaci√≥n</option>
              <option value="LAS" {% if producto.tech == "LAS" %}selected{% endif %}>Grabado l√°ser</option>
              <option value="3D"  {% if producto.tech == "3D"  %}selected{% endif %}>Impresi√≥n 3D</option>
              <option value="OTR" {% if producto.tech == "OTR" %}selected{% endif %}>Otro</option>
            </select>
          </div>

          <!-- ‚úÖ IMAGEN -->
          <div class="col-md-12">
            <label class="form-label">Imagen principal</label>

            {% if producto.imagen %}
              <div class="d-flex align-items-center gap-3 mb-2">
                <img src="{{ producto.imagen.url }}" alt="Imagen del producto"
                  style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px;" class="border">
                <div class="small text-muted">
                  Imagen actual cargada.<br>
                  Si sub√≠s otra, se reemplaza.
                </div>
              </div>

              <!-- ‚úÖ Eliminar imagen -->
              <button type="submit" name="action" value="delete_image"
                      class="btn btn-sm btn-outline-danger mb-2"
                      onclick="return confirm('¬øEliminar la imagen actual?')">
                üóëÔ∏è Eliminar imagen
              </button>
            {% else %}
              <div class="small text-muted mb-2">
                Este producto todav√≠a no tiene imagen.
              </div>
            {% endif %}

            <input type="file" name="imagen" class="form-control" accept="image/*">
            <div class="form-text">
              Formatos recomendados: JPG/PNG. Ideal cuadrada (ej: 800√ó800).
            </div>
          </div>

          <div class="col-md-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="activoCheck" name="activo"
                {% if producto.activo %}checked{% endif %}>
              <label class="form-check-label" for="activoCheck">
                Producto activo (se puede usar en el cat√°logo / c√°lculos)
              </label>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4">
          <div>
            <a href="{% url 'owner_producto_variantes' producto.id %}" class="btn btn-outline-primary">
              Gestionar variantes
            </a>
          </div>

          <div>
            <button type="submit" class="btn btn-primary">
              Guardar cambios
            </button>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
              Cancelar
            </a>
          </div>
        </div>
      </form>

    </div>
  </div>
</div>

<script>
  const skuInput = document.getElementById("id_sku");
  const ta = document.getElementById("skuTypeahead");

  let timer = null;
  let taIndex = -1;

  function hideTA() {
    ta.style.display = "none";
    ta.innerHTML = "";
    taIndex = -1;
  }

  function showTA(items) {
    ta.innerHTML = "";
    if (!items.length) {
      const div = document.createElement("div");
      div.className = "dropdown-item text-muted";
      div.textContent = "Sin resultados";
      ta.appendChild(div);
    } else {
      items.forEach((p) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "dropdown-item";
        btn.innerHTML = `<strong>${p.sku}</strong> ‚Äî ${p.nombre_publico}
                         <span class="badge text-bg-light ms-2">$ ${p.precio}</span>`;
        btn.addEventListener("click", () => {
          window.location.href = `{% url 'owner_producto_editar' 0 %}`.replace("/0/", `/${p.id}/`);
        });
        ta.appendChild(btn);
      });
    }
    ta.style.display = "block";
    taIndex = -1;
  }

  function moveSelection(delta) {
    const items = Array.from(ta.querySelectorAll(".dropdown-item"));
    if (!items.length) return;
    taIndex = Math.max(0, Math.min(items.length - 1, taIndex + delta));
    items.forEach((el, i) => el.classList.toggle("active", i === taIndex));
    items[taIndex].scrollIntoView({ block: "nearest" });
  }

  function pickSelection() {
    const items = Array.from(ta.querySelectorAll(".dropdown-item"));
    if (taIndex >= 0 && taIndex < items.length) items[taIndex].click();
  }

  async function suggest(term) {
    const r = await fetch(`{% url 'owner_api_product_suggest' %}?q=${encodeURIComponent(term)}`);
    if (!r.ok) return { results: [] };
    return r.json();
  }

  skuInput.addEventListener("input", () => {
    const term = skuInput.value.trim();
    if (timer) clearTimeout(timer);
    if (!term) { hideTA(); return; }

    timer = setTimeout(async () => {
      try {
        const data = await suggest(term);
        showTA(data.results || []);
      } catch (e) {
        ta.innerHTML = '<div class="dropdown-item text-danger">Error buscando</div>';
        ta.style.display = "block";
      }
    }, 200);
  });

  skuInput.addEventListener("keydown", (e) => {
    if (ta.style.display !== "block") return;
    if (e.key === "ArrowDown") { e.preventDefault(); moveSelection(1); }
    else if (e.key === "ArrowUp") { e.preventDefault(); moveSelection(-1); }
    else if (e.key === "Enter") { e.preventDefault(); pickSelection(); }
    else if (e.key === "Escape") { hideTA(); }
  });

  skuInput.addEventListener("blur", () => setTimeout(hideTA, 150));
</script>
{% endblock %}
