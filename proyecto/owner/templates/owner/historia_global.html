{% extends "base.html" %}
{% block title %}Historia de eventos{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div>
      <h1 class="h4 mb-1">Historia / Bitácora</h1>
      <div class="text-muted small">
        Todos los movimientos importantes: carrito, compras, productos, listas, facturas, configuración, etc.
      </div>
    </div>
  </div>

  {# FILTROS #}
  {% if tipos or usuarios %}
  <form method="get" class="card card-body mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label small mb-1">Buscar texto</label>
        <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm" placeholder="Título, detalle, modelo…">
      </div>

      <div class="col-md-3">
        <label class="form-label small mb-1">Tipo de evento</label>
        <select name="tipo" class="form-select form-select-sm">
          <option value="">Todos</option>
          {% for code, label in tipos %}
            <option value="{{ code }}" {% if code == tipo_actual %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label small mb-1">Usuario</label>
        <select name="user" class="form-select form-select-sm">
          <option value="">Todos</option>
          {% for u in usuarios %}
            <option value="{{ u.id }}" {% if user_actual and user_actual|add:'' == u.id|add:'' %}selected{% endif %}>
              {{ u.get_full_name|default:u.username }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2 text-end">
        <button class="btn btn-sm btn-primary w-100">Filtrar</button>
      </div>
    </div>
  </form>
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 180px;">Fecha / hora</th>
              <th style="width: 180px;">Tipo</th>
              <th style="width: 160px;">Usuario</th>
              <th>Título</th>
              <th style="width: 120px;" class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% if eventos %}
              {% for ev in eventos %}
                {# Fila principal #}
                <tr>
                  <td class="small text-muted">
                    {{ ev.created_at|date:"d/m/Y H:i" }}
                  </td>
                  <td>
                    <span class="badge bg-light text-dark border">
                      {{ ev.get_tipo_display }}
                    </span>
                  </td>
                  <td class="small">
                    {% if ev.usuario %}
                      {{ ev.usuario.get_full_name|default:ev.usuario.username }}
                    {% else %}
                      <span class="text-muted">Sistema</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="fw-semibold">{{ ev.titulo }}</div>
                    {% if ev.detalle %}
                      <div class="small text-muted text-truncate" style="max-width: 420px;">
                        {{ ev.detalle }}
                      </div>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if ev.archivo %}
                      <a href="{{ ev.archivo.url }}" class="btn btn-xs btn-outline-primary me-1" target="_blank">
                        Ver archivo
                      </a>
                    {% endif %}
                    <button
                      class="btn btn-xs btn-outline-secondary"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#ev-tech-{{ ev.id }}"
                      aria-expanded="false"
                      aria-controls="ev-tech-{{ ev.id }}">
                      Ver detalles técnicos
                    </button>
                  </td>
                </tr>

                {# Fila extra para detalles técnicos #}
                <tr class="bg-light">
                  <td colspan="5" class="p-0 border-0">
                    <div id="ev-tech-{{ ev.id }}" class="collapse">
                      <div class="px-3 pb-3 pt-2">
                        <div class="border rounded bg-white p-2 bitacora-tech-wrapper">
                          <div class="row g-2">
                            <div class="col-md-6">
                              <div class="small text-muted mb-1 fw-semibold">
                                Datos principales
                              </div>
                              <ul class="small mb-2 ps-3">
                                <li><b>Modelo:</b> {{ ev.obj_model|default:"—" }}</li>
                                <li><b>Objeto ID:</b> {{ ev.obj_id|default:"—" }}</li>
                              </ul>
                            </div>
                            <div class="col-md-6">
                              <div class="small text-muted mb-1 fw-semibold">
                                Extra (JSON / metadata)
                              </div>
                            </div>
                          </div>

                          <div class="bitacora-tech-content mt-1">
                            {% if ev.extra %}
                              <pre class="mb-0 bitacora-tech-pre">
{{ ev.extra|safe }}
                              </pre>
                            {% else %}
                              <div class="small text-muted">
                                No hay datos extra registrados para este evento.
                              </div>
                            {% endif %}
                          </div>

                          {% if ev.detalle %}
                            <hr class="my-2">
                            <div class="small">
                              <span class="text-muted fw-semibold">Detalle legible:</span><br>
                              {{ ev.detalle }}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center py-4 text-muted">
                  Todavía no hay eventos registrados.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
  .bitacora-tech-wrapper {
    max-height: 320px;
    overflow: auto;
  }
  .bitacora-tech-pre {
    font-family: monospace;
    font-size: 0.78rem;
    white-space: pre-wrap;
    word-break: break-word;
  }
</style>
{% endblock %}

