{% extends "base.html" %}
{% block title %}Nuevo art√≠culo{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h5 mb-1">‚ûï Subir art√≠culo</h1>
      <p class="text-muted small mb-0">Carg√° un nuevo producto para el cat√°logo.</p>
    </div>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'home' %}">‚Üê Volver</a>
  </div>

  {# Errores generales del formulario principal #}
  {% if form.non_field_errors %}
    <div class="alert alert-danger small mb-3">
      {{ form.non_field_errors }}
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="card shadow-sm" id="mainForm">
    <div class="card-body">
      {% csrf_token %}

      {# ================= DATOS B√ÅSICOS ================= #}
      <h2 class="h6 text-uppercase text-muted mb-3">Datos b√°sicos</h2>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label mb-1">SKU (admin) *</label>
          <div class="position-relative">
            {{ form.sku }}
            <div id="skuTypeahead" class="dropdown-menu w-100 p-0"
                 style="display:none; max-height:280px; overflow:auto;"></div>
          </div>
          <div class="form-text">C√≥digo interno para identificar el producto.</div>
          {% for e in form.sku.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-8">
          <label class="form-label mb-1">Nombre p√∫blico</label>
          {{ form.nombre_publico }}
          <div class="form-text">Es el nombre que van a ver tus clientes en la tienda.</div>
          {% for e in form.nombre_publico.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-12">
          <label class="form-label mb-1">Descripci√≥n</label>
          {{ form.descripcion }}
          <div class="form-text">Informaci√≥n extra del producto: materiales, medidas, aclaraciones, etc.</div>
          {% for e in form.descripcion.errors %}
            <div class="text-danger small">{{ e }}</div>
          {% endfor %}
        </div>
      </div>

      <hr class="my-4">

      {# ================= CLASIFICACI√ìN ================= #}
      <h2 class="h6 text-uppercase text-muted mb-3">Clasificaci√≥n</h2>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label mb-1">Filtro / T√©cnica</label>
          {{ form.tech }}
          <div class="form-text">Ej: Sublimaci√≥n, Grabado l√°ser, Impresi√≥n 3D.</div>
          {% for e in form.tech.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-4">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <label class="form-label mb-0">Rubro</label>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnNuevoRubro">
              + Nuevo rubro
            </button>
          </div>
          <select name="rubro_nombre" class="form-select" id="id_rubro">
            <option value="">(Sin rubro)</option>
            {% for r in rubros %}
              <option value="{{ r.nombre }}" data-rubro-id="{{ r.id }}" data-tech="{{ r.tech }}">
                [{{ r.tech }}] {{ r.nombre }}
              </option>
            {% endfor %}
          </select>
          <div class="form-text">
            Se guarda como texto en el producto (coincide con <code>Rubro.nombre</code>).
          </div>
        </div>

        <div class="col-md-5">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <label class="form-label mb-0">Sub-filtro</label>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnNuevoSubrubro">
              + Nuevo sub-filtro
            </button>
          </div>
          <select name="subrubro_nombre" class="form-select" id="id_subrubro">
            <option value="">(Sin sub-filtro)</option>
            {% for s in subrubros %}
              <option value="{{ s.nombre }}" data-rubro-id="{{ s.rubro_id }}">
                {{ s.rubro.nombre }} ‚Üí {{ s.nombre }}
              </option>
            {% endfor %}
          </select>
          <div class="form-text">Opcional: afina un poco m√°s la categor√≠a.</div>
        </div>
      </div>

      <hr class="my-4">

      {# ================= IMAGEN Y PRECIOS ================= #}
      <h2 class="h6 text-uppercase text-muted mb-3">Imagen y precios</h2>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label mb-1">Imagen principal</label>
          {{ form.imagen }}
          <div class="form-text">Recomendado: formato cuadrado, buena iluminaci√≥n.</div>
          {% for e in form.imagen.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-2">
          <label class="form-label mb-1">Precio</label>
          {{ form.precio }}
          <div class="form-text">Precio final de venta.</div>
          {% for e in form.precio.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-2">
          <label class="form-label mb-1">Stock</label>
          {{ form.stock }}
          <div class="form-text">Si us√°s variantes, se recalcula al guardar.</div>
          {% for e in form.stock.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-2">
          <label class="form-label mb-1">Precio costo (opcional)</label>
          {{ form.precio_costo }}
          <div class="form-text">Solo visible para vos.</div>
          {% for e in form.precio_costo.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <div class="form-check">
            {{ form.activo }}
            <label class="form-check-label">Activo</label>
          </div>
        </div>
      </div>

      <hr class="my-4">

      {# ================= VARIANTES ================= #}
      <div class="d-flex align-items-center justify-content-between gap-2">
        <div>
          <h2 class="h6 mb-1">üéõÔ∏è Variantes (opcional)</h2>
          <div class="form-text">
            Ej: ‚ÄúRojo‚Äù, ‚Äú400cc‚Äù, ‚ÄúGlitter‚Äù. Si dej√°s precio vac√≠o: usa el precio principal.
          </div>

          {# Errores generales del formset #}
          {% if vformset.non_form_errors %}
            <div class="alert alert-danger small mt-2 mb-0">
              {{ vformset.non_form_errors }}
            </div>
          {% endif %}
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddVar">
          + Agregar variante
        </button>
      </div>

      <div class="mt-3">
        {{ vformset.management_form }}

        <div id="variantsContainer" class="vstack gap-2">
          {% for f in vformset %}
            <div class="card border-0 shadow-sm variant-item">
              <div class="card-body">
                <div class="row g-2 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label">Nombre *</label>
                    {{ f.nombre }}
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Descripci√≥n corta</label>
                    {{ f.descripcion_corta }}
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Imagen</label>
                    {{ f.imagen }}
                  </div>
                  <div class="col-md-1">
                    <label class="form-label">Stock</label>
                    {{ f.stock }}
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Precio (opcional)</label>
                    {{ f.precio }}
                  </div>

                  <div class="col-12 d-flex justify-content-between align-items-center mt-2">
                    <div class="d-none">
                      {{ f.id }} {{ f.DELETE }}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger btnRemoveVar">
                      Eliminar
                    </button>
                    <small class="text-muted">Si elimin√°s, se borra al guardar.</small>
                  </div>
                </div>

                {# Errores espec√≠ficos de esta variante #}
                {% if f.errors or f.non_field_errors %}
                  <div class="mt-2 text-danger small">
                    {{ f.errors }}
                    {{ f.non_field_errors }}
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- plantilla para JS -->
        <template id="emptyVarTemplate">
          <div class="card border-0 shadow-sm variant-item">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label">Nombre *</label>
                  {{ vformset.empty_form.nombre }}
                </div>
                <div class="col-md-3">
                  <label class="form-label">Descripci√≥n corta</label>
                  {{ vformset.empty_form.descripcion_corta }}
                </div>
                <div class="col-md-3">
                  <label class="form-label">Imagen</label>
                  {{ vformset.empty_form.imagen }}
                </div>
                <div class="col-md-1">
                  <label class="form-label">Stock</label>
                  {{ vformset.empty_form.stock }}
                </div>
                <div class="col-md-2">
                  <label class="form-label">Precio (opcional)</label>
                  {{ vformset.empty_form.precio }}
                </div>

                <div class="col-12 d-flex justify-content-between align-items-center mt-2">
                  <div class="d-none">
                    {{ vformset.empty_form.id }} {{ vformset.empty_form.DELETE }}
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-danger btnRemoveVar">
                    Eliminar
                  </button>
                  <small class="text-muted">Si elimin√°s, se borra al guardar.</small>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-4">
        <button class="btn btn-primary" type="submit">Guardar</button>
        <a class="btn btn-outline-secondary" href="{% url 'home' %}">Cancelar</a>
      </div>

    </div>
  </form>
</div>

{# ==== SCRIPTS (los mismos que ya ten√≠as, sin cambios de l√≥gica) ==== #}
<script>
  // ===================== Variantes (Formset din√°mico) =====================
  (function () {
    // usamos el prefix REAL del formset (por ejemplo "variants")
    const prefix = "{{ vformset.prefix }}";
    const container = document.getElementById("variantsContainer");
    const addBtn = document.getElementById("btnAddVar");
    const tpl = document.getElementById("emptyVarTemplate");
    const mainNameInput = document.getElementById("id_nombre_publico");

    if (!container || !addBtn || !tpl) return;

    function totalFormsInput() {
      return document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
    }

    function renumberForm(html, index) {
      // reemplaza __prefix__ por el √≠ndice real
      return html.replaceAll("__prefix__", String(index));
    }

    function removeSafe(item) {
      const del = item.querySelector(`input[name$="-DELETE"]`);
      if (del) del.checked = true;
      item.style.display = "none";
    }

    // Copia el nombre principal cuando el input de variante recibe foco por primera vez
    function wireNameCopy(scope) {
      if (!mainNameInput) return;
      const baseName = mainNameInput.value || "";

      scope.querySelectorAll('input[name$="-nombre"]').forEach(input => {
        if (input.dataset.copyBound === "1") return;
        input.dataset.copyBound = "1";

        input.addEventListener("focus", function () {
          if (!this.value && baseName) {
            this.value = baseName;
          }
        });
      });
    }

    function wireExisting() {
      container.querySelectorAll(".btnRemoveVar").forEach(btn => {
        btn.addEventListener("click", () => {
          const item = btn.closest(".variant-item");
          if (item) removeSafe(item);
        });
      });
      wireNameCopy(container);
    }

    addBtn.addEventListener("click", () => {
      const totalEl = totalFormsInput();
      if (!totalEl) {
        console.error("No se encontr√≥ TOTAL_FORMS para el prefix", prefix);
        return;
      }

      const index = parseInt(totalEl.value || "0", 10);

      const cloneHTML = renumberForm(tpl.innerHTML, index);
      const temp = document.createElement("div");
      temp.innerHTML = cloneHTML.trim();
      const node = temp.firstElementChild;

      container.appendChild(node);
      totalEl.value = index + 1;

      const btn = node.querySelector(".btnRemoveVar");
      if (btn) {
        btn.addEventListener("click", () => removeSafe(node));
      }

      // copiar nombre principal en la nueva variante (al enfocar)
      wireNameCopy(node);
    });

    wireExisting();
  })();
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ===================== DOM references =====================
    const skuInput = document.getElementById("id_sku");
    const nameInput = document.getElementById("id_nombre_publico");
    const priceInput = document.getElementById("id_precio");
    const stockInput = document.getElementById("id_stock");
    const costInput = document.getElementById("id_precio_costo");
    const techSelect = document.getElementById("id_tech");
    const activeChk = document.getElementById("id_activo");

    const ta = document.getElementById("skuTypeahead");

    let timer = null;
    let taIndex = -1;

    // ===================== Typeahead SKU =====================
    function hideTA() {
      ta.style.display = "none";
      ta.innerHTML = "";
      taIndex = -1;
    }

    function showTA(items) {
      ta.innerHTML = "";
      if (!items.length) {
        const div = document.createElement("div");
        div.className = "dropdown-item text-muted";
        div.textContent = "Sin resultados";
        ta.appendChild(div);
      } else {
        items.forEach((p) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "dropdown-item";
          btn.innerHTML = `<strong>${p.sku}</strong> ‚Äî ${p.nombre_publico}
                           <span class="badge text-bg-light ms-2">$ ${p.precio}</span>`;
          btn.addEventListener("click", () => selectProduct(p.id));
          ta.appendChild(btn);
        });
      }
      ta.style.display = "block";
      taIndex = -1;
    }

    function moveSelection(delta) {
      const items = Array.from(ta.querySelectorAll(".dropdown-item"));
      if (!items.length) return;
      taIndex = Math.max(0, Math.min(items.length - 1, taIndex + delta));
      items.forEach((el, i) => el.classList.toggle("active", i === taIndex));
      items[taIndex].scrollIntoView({ block: "nearest" });
    }

    function pickSelection() {
      const items = Array.from(ta.querySelectorAll(".dropdown-item"));
      if (taIndex >= 0 && taIndex < items.length) items[taIndex].click();
    }

    async function suggest(term) {
      const r = await fetch(`{% url 'owner_api_product_suggest' %}?q=${encodeURIComponent(term)}`);
      if (!r.ok) return { results: [] };
      return r.json();
    }

    async function selectProduct(id) {
      hideTA();
      const r = await fetch(`{% url 'owner_api_product_detail' 0 %}`.replace("/0/", `/${id}/`));
      if (!r.ok) return;

      const p = await r.json();

      skuInput.value = p.sku || "";
      nameInput.value = p.nombre_publico || "";
      priceInput.value = p.precio || "";
      stockInput.value = p.stock ?? 0;
      if (costInput) costInput.value = p.precio_costo || "";
      if (techSelect) techSelect.value = p.tech || "";
      if (activeChk) activeChk.checked = !!p.activo;
    }

    if (skuInput && ta) {
      skuInput.addEventListener("input", () => {
        const term = skuInput.value.trim();
        if (timer) clearTimeout(timer);
        if (!term) { hideTA(); return; }

        timer = setTimeout(async () => {
          try {
            const data = await suggest(term);
            showTA(data.results || []);
          } catch (e) {
            ta.innerHTML = '<div class="dropdown-item text-danger">Error buscando</div>';
            ta.style.display = "block";
          }
        }, 200);
      });

      skuInput.addEventListener("keydown", (e) => {
        if (ta.style.display !== "block") return;
        if (e.key === "ArrowDown") { e.preventDefault(); moveSelection(1); }
        else if (e.key === "ArrowUp") { e.preventDefault(); moveSelection(-1); }
        else if (e.key === "Enter") { e.preventDefault(); pickSelection(); }
        else if (e.key === "Escape") { hideTA(); }
      });

      skuInput.addEventListener("blur", () => setTimeout(hideTA, 150));
    }

    // =============== Filtros Rubro / Subrubro / T√©cnica ===============
    const rubroSelect = document.getElementById("id_rubro");
    const subrubroSelect = document.getElementById("id_subrubro");
    const btnNuevoRubro = document.getElementById("btnNuevoRubro");
    const btnNuevoSubrubro = document.getElementById("btnNuevoSubrubro");

    // poner data-tech en las opciones de rubro leyendo el texto "[LAS] Nombre"
    function initRubroTechData() {
      if (!rubroSelect) return;
      Array.from(rubroSelect.options).forEach(opt => {
        if (!opt.value) return; // "(Sin rubro)"
        if (opt.getAttribute("data-tech")) return;

        const txt = opt.textContent.trim();
        const m = txt.match(/^\[([A-Z0-9]+)\]/);
        if (m) {
          opt.setAttribute("data-tech", m[1]);
        }
      });
    }

    function filtrarSubrubros() {
      if (!rubroSelect || !subrubroSelect) return;
      const rubroOption = rubroSelect.options[rubroSelect.selectedIndex];
      const rubroId = rubroOption ? rubroOption.getAttribute("data-rubro-id") : null;

      Array.from(subrubroSelect.options).forEach(function (opt) {
        const optRubroId = opt.getAttribute("data-rubro-id");

        if (!optRubroId || !rubroId) {
          // Primera opci√≥n "sin sub-filtro" o no hay rubro seleccionado
          opt.hidden = false;
        } else {
          opt.hidden = (optRubroId !== rubroId);
        }
      });

      // Si el subrubro seleccionado ya no coincide con el rubro, lo limpiamos
      const sel = subrubroSelect.selectedOptions[0];
      if (sel && sel.hidden) {
        subrubroSelect.value = "";
      }
    }

    function filtrarRubrosPorTech() {
      if (!rubroSelect) return;
      const tech = techSelect ? techSelect.value : "";

      Array.from(rubroSelect.options).forEach(opt => {
        if (!opt.value) {
          opt.hidden = false; // "(Sin rubro)"
          return;
        }

        const rubroTech = opt.getAttribute("data-tech");

        if (!tech) {
          opt.hidden = false; // sin t√©cnica, mostramos todo
        } else if (!rubroTech) {
          opt.hidden = false; // si no sabemos la t√©cnica del rubro, no lo escondemos
        } else {
          opt.hidden = (rubroTech !== tech);
        }
      });

      const selected = rubroSelect.selectedOptions[0];
      if (selected && selected.hidden) {
        rubroSelect.value = "";
      }

      filtrarSubrubros();
    }

    if (rubroSelect && subrubroSelect) {
      rubroSelect.addEventListener("change", filtrarSubrubros);
      filtrarSubrubros();
    }

    if (techSelect && rubroSelect) {
      initRubroTechData();
      techSelect.addEventListener("change", filtrarRubrosPorTech);
      filtrarRubrosPorTech();
    }

    // ====== CSRF helper ======
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    // ====== Crear Rubro desde producto ======
    async function crearRubroDesdeProducto() {
      if (!techSelect || !rubroSelect) return;

      const tech = techSelect.value || "";
      const nombre = prompt("Nombre del nuevo rubro (ej: Mates, Tazas, Llaveros):");
      if (!nombre) return;

      try {
        const resp = await fetch("{% url 'owner_api_rubro_create' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": csrftoken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams({
            nombre: nombre,
            tech: tech,
          }),
        });

        const data = await resp.json();
        if (!resp.ok || !data.ok) {
          alert(data.error || "Error al crear el rubro.");
          return;
        }

        const r = data.rubro;

        const opt = document.createElement("option");
        opt.value = r.nombre;
        opt.textContent = `[${r.tech || ""}] ${r.nombre}`;
        opt.setAttribute("data-rubro-id", r.id);
        opt.setAttribute("data-tech", r.tech || "");

        rubroSelect.appendChild(opt);
        rubroSelect.value = r.nombre;

        filtrarRubrosPorTech();
        filtrarSubrubros();

        alert(`Rubro ‚Äú${r.nombre}‚Äù creado y asignado al producto.`);
      } catch (e) {
        console.error(e);
        alert("Error inesperado al crear el rubro.");
      }
    }

    // ====== Crear Subrubro desde producto ======
    async function crearSubrubroDesdeProducto() {
      if (!rubroSelect || !subrubroSelect) return;

      const rubroOption = rubroSelect.options[rubroSelect.selectedIndex];
      const rubroId = rubroOption ? rubroOption.getAttribute("data-rubro-id") : null;
      const rubroNombre = rubroOption ? rubroOption.value : "";

      if (!rubroId) {
        alert("Primero seleccion√° un rubro para crear un sub-filtro.");
        return;
      }

      const nombre = prompt(`Nombre del nuevo sub-filtro para ‚Äú${rubroNombre}‚Äù (ej: Mate imperial de calabaza):`);
      if (!nombre) return;

      try {
        const resp = await fetch("{% url 'owner_api_subrubro_create' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": csrftoken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams({
            rubro_id: rubroId,
            nombre: nombre,
          }),
        });

        const data = await resp.json();
        if (!resp.ok || !data.ok) {
          alert(data.error || "Error al crear el sub-filtro.");
          return;
        }

        const s = data.subrubro;

        const opt = document.createElement("option");
        opt.value = s.nombre;
        opt.textContent = `${s.rubro_nombre} ‚Üí ${s.nombre}`;
        opt.setAttribute("data-rubro-id", s.rubro_id);

        subrubroSelect.appendChild(opt);
        subrubroSelect.value = s.nombre;

        alert(`Sub-filtro ‚Äú${s.nombre}‚Äù creado y asignado al producto.`);
      } catch (e) {
        console.error(e);
        alert("Error inesperado al crear el sub-filtro.");
      }
    }

    if (btnNuevoRubro) {
      btnNuevoRubro.addEventListener("click", crearRubroDesdeProducto);
    }
    if (btnNuevoSubrubro) {
      btnNuevoSubrubro.addEventListener("click", crearSubrubroDesdeProducto);
    }
  });
</script>

{% endblock %}
