{% extends "base.html" %}

{% block title %}Nuevo art√≠culo{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h5 mb-0">‚ûï Subir art√≠culo</h1>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'home' %}">‚Üê Volver</a>
  </div>

  <form method="post" enctype="multipart/form-data" class="card shadow-sm">
    <div class="card-body">
      {% csrf_token %}

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">SKU (admin) *</label>
          <div class="position-relative">
            {{ form.sku }}
            <div id="skuTypeahead"
                 class="dropdown-menu w-100 p-0"
                 style="display:none; max-height:280px; overflow:auto;">
            </div>
          </div>
          {% for e in form.sku.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-5">
          <label class="form-label">Nombre p√∫blico</label>
          {{ form.nombre_publico }}
        </div>

        <div class="col-md-3">
          <label class="form-label">Filtro / T√©cnica</label>
          {{ form.tech }}
        </div>

        <div class="col-md-4">
          <label class="form-label">Imagen principal</label>
          {{ form.imagen }}
        </div>

        <div class="col-md-2">
          <label class="form-label">Precio</label>
          {{ form.precio }}
        </div>

        <div class="col-md-2">
          <label class="form-label">Stock</label>
          {{ form.stock }}
          <div class="form-text">Si us√°s variantes, se recalcula al guardar.</div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Precio costo (opcional)</label>
          {{ form.precio_costo }}
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <div class="form-check">
            {{ form.activo }}
            <label class="form-check-label">Activo</label>
          </div>
        </div>
      </div>

      <hr class="my-3">

      <h2 class="h6 mb-2">üéõÔ∏è Variantes (opcional)</h2>
      <div class="form-text mb-2">Ej: ‚ÄúRojo‚Äù, ‚Äú400cc‚Äù, ‚ÄúGlitter‚Äù. Pod√©s cargar 0, 1 o varias.</div>

      {{ vformset.management_form }}

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Descripci√≥n corta</th>
              <th>Imagen</th>
              <th>Stock</th>
              <th>Orden</th>
              <th>Activo</th>
              <th>Borrar</th>
            </tr>
          </thead>
          <tbody>
            {% for f in vformset %}
              <tr>
                <td style="min-width:180px">{{ f.nombre }}</td>
                <td style="min-width:220px">{{ f.descripcion_corta }}</td>
                <td style="min-width:220px">{{ f.imagen }}</td>
                <td style="max-width:120px">{{ f.stock }}</td>
                <td style="max-width:120px">{{ f.orden }}</td>
                <td class="text-center">{{ f.activo }}</td>
                <td class="text-center">{{ f.DELETE }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <button class="btn btn-primary" type="submit">Guardar</button>
        <a class="btn btn-outline-secondary" href="{% url 'home' %}">Cancelar</a>
      </div>
    </div>
  </form>
</div>

<script>
  // DOM references
  const skuInput = document.getElementById("id_sku");
  const nameInput = document.getElementById("id_nombre_publico");
  const priceInput = document.getElementById("id_precio");
  const stockInput = document.getElementById("id_stock");
  const costInput = document.getElementById("id_precio_costo");
  const techSelect = document.getElementById("id_tech");
  const activeChk = document.getElementById("id_activo");

  const ta = document.getElementById("skuTypeahead");

  let timer = null;
  let taIndex = -1;

  // Hide the dropdown
  function hideTA() {
    ta.style.display = "none";
    ta.innerHTML = "";
    taIndex = -1;
  }

  // Show the dropdown with results
  function showTA(items) {
    ta.innerHTML = "";
    if (!items.length) {
      const div = document.createElement("div");
      div.className = "dropdown-item text-muted";
      div.textContent = "Sin resultados";
      ta.appendChild(div);
    } else {
      items.forEach((p, i) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "dropdown-item";
        btn.innerHTML = `<strong>${p.sku}</strong> ‚Äî ${p.nombre_publico}
                         <span class="badge text-bg-light ms-2">$ ${p.precio}</span>`;
        btn.addEventListener("click", () => selectProduct(p.id));
        ta.appendChild(btn);
      });
    }
    ta.style.display = "block";
    taIndex = -1;
  }

  // Move the selection in the dropdown
  function moveSelection(delta) {
    const items = Array.from(ta.querySelectorAll(".dropdown-item"));
    if (!items.length) return;
    taIndex = Math.max(0, Math.min(items.length - 1, taIndex + delta));
    items.forEach((el, i) => el.classList.toggle("active", i === taIndex));
    items[taIndex].scrollIntoView({ block: "nearest" });
  }

  // Pick the current selection in the dropdown
  function pickSelection() {
    const items = Array.from(ta.querySelectorAll(".dropdown-item"));
    if (taIndex >= 0 && taIndex < items.length) items[taIndex].click();
  }

  // API request to fetch products based on input
  async function suggest(term) {
    const r = await fetch(`{% url 'owner_api_product_suggest' %}?q=${encodeURIComponent(term)}`);
    if (!r.ok) return { results: [] };
    return r.json();
  }

  // Select the product and autofill the fields
  async function selectProduct(id) {
    hideTA();
    const r = await fetch(`{% url 'owner_api_product_detail' 0 %}`.replace("/0/", `/${id}/`));
    if (!r.ok) return;

    const p = await r.json();

    // Autofill fields
    skuInput.value = p.sku || "";
    nameInput.value = p.nombre_publico || "";
    priceInput.value = p.precio || "";
    stockInput.value = p.stock ?? 0;
    if (costInput) costInput.value = p.precio_costo || "";
    if (techSelect) techSelect.value = p.tech || "";
    if (activeChk) activeChk.checked = !!p.activo;
  }

  // Event listener for SKU input
  skuInput.addEventListener("input", () => {
    const term = skuInput.value.trim();
    if (timer) clearTimeout(timer);
    if (!term) { hideTA(); return; }

    timer = setTimeout(async () => {
      try {
        const data = await suggest(term);
        showTA(data.results || []);
      } catch (e) {
        ta.innerHTML = '<div class="dropdown-item text-danger">Error buscando</div>';
        ta.style.display = "block";
      }
    }, 200);
  });

  // Event listener for arrow keys and Enter in SKU input
  skuInput.addEventListener("keydown", (e) => {
    if (ta.style.display !== "block") return;
    if (e.key === "ArrowDown") { e.preventDefault(); moveSelection(1); }
    else if (e.key === "ArrowUp") { e.preventDefault(); moveSelection(-1); }
    else if (e.key === "Enter") { e.preventDefault(); pickSelection(); }
    else if (e.key === "Escape") { hideTA(); }
  });

  // Hide dropdown when losing focus
  skuInput.addEventListener("blur", () => setTimeout(hideTA, 150));
</script>
{% endblock %}
