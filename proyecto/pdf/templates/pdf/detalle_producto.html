{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ producto.nombre_publico }}{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="row g-4 align-items-start">

    <!-- ===================== -->
    <!-- IMAGEN DEL PRODUCTO -->
    <!-- ===================== -->
    <div class="col-md-6 text-center">
      <div class="border rounded p-3 bg-white shadow-sm">
        {% if producto.imagen %}
        <img id="product-image" src="{{ producto.imagen.url }}" class="img-fluid rounded"
          alt="{{ producto.nombre_publico }}" style="max-height: 420px; object-fit: contain;">
        {% else %}
        <div class="bg-light p-5 border rounded text-muted">
          Sin imagen
        </div>
        {% endif %}
      </div>
    </div>

    <!-- ===================== -->
    <!-- INFO DEL PRODUCTO -->
    <!-- ===================== -->
    <div class="col-md-6">

      <h2 class="mb-1">{{ producto.nombre_publico }}</h2>

      <div class="mb-3">
        <span class="h3 text-success fw-bold">
          $<span id="price-amount">
            {% if variantes_ui %}
              {{ precio_inicial|floatformat:0|intcomma }}
            {% else %}
              {{ producto.precio|floatformat:0|intcomma }}
            {% endif %}
          </span>
        </span>
      </div>

      {# BADGE STOCK (dinÃ¡mico) #}
      <div class="mb-3">
        <span id="stock-badge"
              class="badge {% if stock_inicial|default:0 <= 0 %}bg-danger{% else %}bg-success{% endif %}">
          {% if stock_inicial|default:0 <= 0 %}Sin stock{% else %}En stock{% endif %}
        </span>
        <small class="text-muted ms-2">
          Disponibles: <span id="stock-num">{{ stock_inicial|default:0 }}</span>
        </small>
      </div>

      <!-- ===================== -->
      <!-- VARIANTES -->
      <!-- ===================== -->
      {% if variantes_ui %}
      <div class="mb-3">
        <label class="form-label fw-semibold">
          Variante
        </label>

        <select id="variant-select" class="form-select">
          {% for v in variantes_ui %}
          <option value="{{ v.id }}"
            {% if v.imagen %}
              data-image="{{ v.imagen.url }}"
            {% elif producto.imagen %}
              data-image="{{ producto.imagen.url }}"
            {% endif %}
            data-desc="{{ v.descripcion_corta|default:'' }}"
            data-stock="{{ v.stock|default:0 }}"
            data-price="{{ v.precio_final|floatformat:0|intcomma }}"
          >
            {{ v.nombre }}{% if v.es_principal %} (Principal){% endif %}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- DESCRIPCIÃ“N VARIANTE -->
      <div id="variant-desc" class="alert alert-light border small">
        {{ variantes_ui.0.descripcion_corta }}
      </div>
      {% endif %}

      <!-- ===================== -->
      <!-- ACCIONES -->
      <!-- ===================== -->
      <div class="d-grid gap-2 mt-4">
        <form method="post" action="{% url 'agregar_al_carrito' producto.id %}">
          {% csrf_token %}

          {% if variantes_ui %}
          <input type="hidden" name="variante_id" id="variante_id_input" value="{{ variantes_ui.0.id }}">
          {% else %}
          <input type="hidden" name="variante_id" value="0">
          {% endif %}

          <div class="mb-2">
            <label class="form-label fw-semibold">Cantidad</label>
            <input
              type="number"
              class="form-control"
              name="cantidad"
              id="qty-input"
              value="1"
              min="1"
              max="{{ stock_inicial|default:0 }}"
              {% if stock_inicial|default:0 <= 0 %}disabled{% endif %}
            >
            <div class="form-text">
              Se limita automÃ¡ticamente al stock disponible de la variante.
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-lg" id="add-cart-btn"
                  {% if stock_inicial|default:0 <= 0 %}disabled{% endif %}>
            ðŸ›’ Agregar al carrito
          </button>
        </form>
      </div>

    </div>
  </div>

</div>

<!-- JS VARIANTES -->
<script>
  (function () {
    const sel = document.getElementById("variant-select");
    const img = document.getElementById("product-image");
    const desc = document.getElementById("variant-desc");
    const hiddenVar = document.getElementById("variante_id_input");

    const badge = document.getElementById("stock-badge");
    const stockNum = document.getElementById("stock-num");
    const qtyInput = document.getElementById("qty-input");
    const addBtn = document.getElementById("add-cart-btn");
    const priceSpan = document.getElementById("price-amount");

    function applyVariant() {
      if (!sel) return;
      const opt = sel.options[sel.selectedIndex];
      if (!opt) return;

      // id variante
      if (hiddenVar) hiddenVar.value = opt.value;

      // imagen
      const imgUrl = opt.getAttribute("data-image");
      if (img && imgUrl) img.src = imgUrl;

      // descripciÃ³n
      const d = opt.getAttribute("data-desc") || "";
      if (desc) desc.textContent = d;

      // precio (ya viene formateado desde el template)
      const p = opt.getAttribute("data-price");
      if (priceSpan && p !== null && p !== "") {
        priceSpan.textContent = p;
      }

      // stock
      const s = parseInt(opt.getAttribute("data-stock") || "0", 10) || 0;
      if (stockNum) stockNum.textContent = String(s);

      const inStock = s > 0;

      if (badge) {
        badge.classList.remove("bg-danger", "bg-success");
        badge.classList.add(inStock ? "bg-success" : "bg-danger");
        badge.textContent = inStock ? "En stock" : "Sin stock";
      }

      if (qtyInput) {
        qtyInput.max = String(s);
        qtyInput.disabled = !inStock;
        if (!inStock) {
          qtyInput.value = "1";
        } else {
          let current = parseInt(qtyInput.value || "1", 10) || 1;
          if (current > s) current = s;
          if (current < 1) current = 1;
          qtyInput.value = String(current);
        }
      }

      if (addBtn) addBtn.disabled = !inStock;
    }

    if (sel) {
      sel.addEventListener("change", applyVariant);
      applyVariant(); // inicial
    }

    // cuando el usuario cambia cantidad, forzamos lÃ­mite
    if (qtyInput) {
      qtyInput.addEventListener("input", function () {
        const max = parseInt(qtyInput.max || "1", 10) || 1;
        let v = parseInt(qtyInput.value || "1", 10) || 1;
        if (v < 1) v = 1;
        if (v > max) v = max;
        qtyInput.value = String(v);
      });
    }
  })();
</script>
{% endblock %}
