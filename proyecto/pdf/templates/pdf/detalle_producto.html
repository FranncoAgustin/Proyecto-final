{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ producto.nombre_publico }}{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="row g-4 align-items-start">

    <!-- ===================== -->
    <!-- IMAGEN DEL PRODUCTO -->
    <!-- ===================== -->
    <div class="col-md-6 text-center">
      <div class="border rounded p-3 bg-white shadow-sm">
        {% if producto.imagen %}
          <img id="product-image"
               src="{{ producto.imagen.url }}"
               class="img-fluid rounded"
               alt="{{ producto.nombre_publico }}"
               style="max-height: 420px; object-fit: contain;">
        {% else %}
          <div class="bg-light p-5 border rounded text-muted">
            Sin imagen
          </div>
        {% endif %}
      </div>
    </div>

    <!-- ===================== -->
    <!-- INFO DEL PRODUCTO -->
    <!-- ===================== -->
    <div class="col-md-6">

      <h2 class="mb-1">{{ producto.nombre_publico }}</h2>

      <div class="mb-3">
        <span class="h3 text-success fw-bold">
          $<span id="price-amount">
            {% if variantes_ui %}
              {{ precio_inicial|floatformat:0|intcomma }}
            {% else %}
              {{ producto.precio|floatformat:0|intcomma }}
            {% endif %}
          </span>
        </span>
      </div>

      {# BADGE STOCK (din谩mico) #}
      <div class="mb-3">
        <span id="stock-badge"
              class="badge {% if stock_inicial|default:0 <= 0 %}bg-danger{% else %}bg-success{% endif %}">
          {% if stock_inicial|default:0 <= 0 %}Sin stock{% else %}En stock{% endif %}
        </span>
        <!-- <small class="text-muted ms-2">
          Disponibles: <span id="stock-num">{{ stock_inicial|default:0 }}</span>
        </small> -->
        <!-- Badge extra: 煤ltima unidad / pocas unidades -->
        <span id="stock-extra" class="badge ms-2 small d-none"></span>
      </div>

      <!-- ===================== -->
      <!-- CARD DE COMPRA -->
      <!-- ===================== -->
      <div class="card shadow-sm border-0">
        <div class="card-body">

          <!-- ===================== -->
          <!-- VARIANTES -->
          <!-- ===================== -->
          {% if variantes_ui %}
            <div class="mb-3">
              <label class="form-label fw-semibold mb-1">Variante</label>

              <select id="variant-select" class="form-select">
                {% for v in variantes_ui %}
                  <option value="{{ v.id }}"
                    {% if v.imagen %}
                      data-image="{{ v.imagen.url }}"
                    {% elif producto.imagen %}
                      data-image="{{ producto.imagen.url }}"
                    {% endif %}
                    data-principal="{% if v.es_principal %}1{% else %}0{% endif %}"
                    data-desc="{{ v.descripcion_corta|default:'' }}"
                    data-stock="{{ v.stock|default:0 }}"
                    data-price="{{ v.precio_final|floatformat:0|intcomma }}"
                  >
                    {{ v.nombre }}{% if v.es_principal %} (Principal){% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>
          {% endif %}

          <!-- ===================== -->
          <!-- DESCRIPCIN NICA (PRODUCTO / VARIANTE) -->
          <!-- ===================== -->
          <div class="mb-3">
            <div class="d-flex align-items-center justify-content-between">
              <span class="form-label fw-semibold mb-1">Descripci贸n</span>
            </div>

            <div id="variant-desc"
                 class="p-3 bg-light border rounded small"
                 style="white-space: pre-line; min-height: 52px;">
              {# valor inicial; luego JS lo pisa con la l贸gica correcta #}
              {% if variantes_ui %}
                {{ variantes_ui.0.descripcion_corta|default:producto.descripcion|default:"" }}
              {% else %}
                {{ producto.descripcion|default:"" }}
              {% endif %}
            </div>
          </div>

          <!-- ===================== -->
          <!-- ACCIONES -->
          <!-- ===================== -->
          <form method="post" action="{% url 'agregar_al_carrito' producto.id %}">
            {% csrf_token %}

            {% if variantes_ui %}
              <input type="hidden" name="variante_id" id="variante_id_input" value="{{ variantes_ui.0.id }}">
            {% else %}
              <input type="hidden" name="variante_id" value="0">
            {% endif %}

            <div class="mb-2">
              <label class="form-label fw-semibold">Cantidad</label>
              <input
                type="number"
                class="form-control"
                name="cantidad"
                id="qty-input"
                value="1"
                min="1"
                max="{{ stock_inicial|default:0 }}"
                {% if stock_inicial|default:0 <= 0 %}disabled{% endif %}
              >
              <div class="form-text">
                Se limita autom谩ticamente al stock disponible de la variante.
              </div>
            </div>

            <button type="submit"
                    class="btn btn-primary btn-lg w-100"
                    id="add-cart-btn"
                    {% if stock_inicial|default:0 <= 0 %}disabled{% endif %}>
               Agregar al carrito
            </button>
          </form>

        </div>
      </div>

    </div>
  </div>

</div>

<!-- JS VARIANTES -->
<script>
  (function () {
    const sel = document.getElementById("variant-select");
    const img = document.getElementById("product-image");
    const desc = document.getElementById("variant-desc");
    const hiddenVar = document.getElementById("variante_id_input");

    const badge = document.getElementById("stock-badge");
    const stockNum = document.getElementById("stock-num");
    const extra = document.getElementById("stock-extra");
    const qtyInput = document.getElementById("qty-input");
    const addBtn = document.getElementById("add-cart-btn");
    const priceSpan = document.getElementById("price-amount");

    // Descripci贸n principal del producto (fallback)
    const productDesc = "{{ producto.descripcion|default:''|escapejs }}";

    function updateStockExtra(qty) {
      if (!extra) return;

      extra.className = "badge ms-2 small";

      if (qty <= 0) {
        extra.classList.add("d-none");
        extra.textContent = "";
      } else if (qty === 1) {
        extra.classList.remove("d-none");
        extra.classList.add("bg-danger", "text-light", "opacity-75");
        extra.textContent = "ltima unidad";
      } else if (qty > 1 && qty < 5) {
        extra.classList.remove("d-none");
        extra.classList.add("bg-warning", "text-dark", "opacity-75");
        extra.textContent = "Quedan pocas unidades";
      } else {
        extra.classList.add("d-none");
        extra.textContent = "";
      }
    }

    function applyVariant() {
      // Sin variantes: usar s贸lo la descripci贸n del producto y stock actual
      if (!sel) {
        if (desc) desc.textContent = productDesc;
        let s = 0;
        if (stockNum) {
          s = parseInt((stockNum.textContent || stockNum.innerText || "0"), 10) || 0;
        }
        updateStockExtra(s);
        return;
      }

      const opt = sel.options[sel.selectedIndex];
      if (!opt) return;

      // id variante
      if (hiddenVar) hiddenVar.value = opt.value;

      // imagen
      const imgUrl = opt.getAttribute("data-image");
      if (img && imgUrl) img.src = imgUrl;

      // descripci贸n:
      //  - si es principal => SIEMPRE la del producto
      //  - si no es principal => descripcion_corta o fallback al producto
      const isPrincipal = opt.getAttribute("data-principal") === "1";
      if (desc) {
        if (isPrincipal) {
          desc.textContent = productDesc;
        } else {
          const d = (opt.getAttribute("data-desc") || "").trim();
          desc.textContent = d !== "" ? d : productDesc;
        }
      }

      // precio (ya viene formateado desde el template)
      const p = opt.getAttribute("data-price");
      if (priceSpan && p !== null && p !== "") {
        priceSpan.textContent = p;
      }

      // stock
      const s = parseInt(opt.getAttribute("data-stock") || "0", 10) || 0;
      if (stockNum) stockNum.textContent = String(s);

      const inStock = s > 0;

      if (badge) {
        badge.classList.remove("bg-danger", "bg-success");
        badge.classList.add(inStock ? "bg-success" : "bg-danger");
        badge.textContent = inStock ? "En stock" : "Sin stock";
      }

      if (qtyInput) {
        qtyInput.max = String(s);
        qtyInput.disabled = !inStock;

        if (!inStock) {
          qtyInput.value = "1";
        } else {
          let current = parseInt(qtyInput.value || "1", 10) || 1;
          if (current > s) current = s;
          if (current < 1) current = 1;
          qtyInput.value = String(current);
        }
      }

      if (addBtn) addBtn.disabled = !inStock;

      // badge extra de stock
      updateStockExtra(s);
    }

    if (sel) {
      sel.addEventListener("change", applyVariant);
      applyVariant();  // inicial con la variante principal
    } else {
      applyVariant();  // caso sin variantes
    }

    // l铆mite de cantidad
    if (qtyInput) {
      qtyInput.addEventListener("input", function () {
        const max = parseInt(qtyInput.max || "1", 10) || 1;
        let v = parseInt(qtyInput.value || "1", 10) || 1;
        if (v < 1) v = 1;
        if (v > max) v = max;
        qtyInput.value = String(v);
      });
    }
  })();
</script>
{% endblock %}
