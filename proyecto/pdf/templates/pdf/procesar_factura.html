{% extends "base.html" %}

{% block title %}Procesar Factura{% endblock %}

{% block content %}
<div class="container py-3">

  <!-- HEADER -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h5 mb-0">Cargar Factura de Proveedor</h1>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'home' %}">← Volver</a>
  </div>

  {% if msg_success %}
    <div class="alert alert-success text-center">
      {{ msg_success }}
    </div>
    <div class="text-center mb-4">
      <a href="{% url 'procesar_factura' %}" class="btn btn-primary">
        Subir otra factura
      </a>
    </div>
  {% endif %}

  {# ===================================================== #}
  {# PASO 1 — SUBIR FACTURA                                #}
  {# ===================================================== #}
  {% if not preview|default:False and not msg_success %}
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label fw-bold">Archivo PDF</label>
            {{ form.archivo }}
          </div>

          <div class="col-md-6">
            <label class="form-label fw-bold">Texto manual (opcional)</label>
            <textarea name="texto_manual" rows="5" class="form-control"
              placeholder="Pegá acá el texto si el PDF no tiene OCR"></textarea>
          </div>

          <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary">
              Analizar factura
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  {# ===================================================== #}
  {# PASO 2 — REVISIÓN                                    #}
  {# ===================================================== #}
  {% if preview|default:False %}

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="confirmar_factura" value="1">

    <!-- DATALIST DEL CATÁLOGO -->
    <datalist id="catalogoProductos">
      {% for p in productos_livianos %}
        <option value="{{ p.sku }}">{{ p.nombre_publico }}</option>
      {% endfor %}
    </datalist>

    <!-- ================= ACCIONES MASIVAS ================= -->
    <div class="d-flex flex-wrap gap-2 align-items-center p-2 mb-2 border rounded bg-light">
      <strong class="small text-muted">Acciones masivas:</strong>

      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-outline-secondary"
          onclick="bulkSet('.bulk-item-check', true); actualizarTotalGeneral();">
          Seleccionar todos
        </button>
        <button type="button" class="btn btn-outline-secondary"
          onclick="bulkSet('.bulk-item-check', false); actualizarTotalGeneral();">
          Deseleccionar todos
        </button>
      </div>

      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-outline-primary"
          onclick="bulkSet('.bulk-upd-stock', true)">
          Stock ✓
        </button>
        <button type="button" class="btn btn-outline-primary"
          onclick="bulkSet('.bulk-upd-stock', false)">
          Stock ✗
        </button>
      </div>

      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-outline-success"
          onclick="bulkSet('.bulk-upd-costo', true)">
          Costo ✓
        </button>
        <button type="button" class="btn btn-outline-success"
          onclick="bulkSet('.bulk-upd-costo', false)">
          Costo ✗
        </button>
      </div>

      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-outline-warning"
          onclick="bulkSet('.bulk-crear', true)">
          Crear ✓
        </button>
        <button type="button" class="btn btn-outline-warning"
          onclick="bulkSet('.bulk-crear', false)">
          Crear ✗
        </button>
      </div>
    </div>

    <!-- ================= TABLA ================= -->
    <div class="card shadow-sm border-0 mb-3">
      <div class="card-header bg-primary text-white d-flex justify-content-between">
        <strong>Datos detectados</strong>
        <input type="date" name="fecha_factura" value="{{ fecha_detectada }}"
               class="form-control form-control-sm w-auto">
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th></th>
              <th>Cant.</th>
              <th>Descripción</th>
              <th>Precio</th>
              <th>Subtotal</th>
              <th>Catálogo</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
            <tr id="row_{{ forloop.counter0 }}">
              <td>
                <input type="checkbox"
                       name="item_{{ forloop.counter0 }}_check"
                       id="check_{{ forloop.counter0 }}"
                       checked
                       class="form-check-input bulk-item-check item-check"
                       onchange="toggleRowVisibility({{ forloop.counter0 }})">
              </td>

              <td>
                <input type="number"
                       name="item_{{ forloop.counter0 }}_cantidad"
                       value="{{ item.cantidad }}"
                       class="form-control form-control-sm text-center"
                       id="cant_{{ forloop.counter0 }}"
                       oninput="calcularFila({{ forloop.counter0 }})">
              </td>

              <td>
                <input type="text"
                       name="item_{{ forloop.counter0 }}_producto"
                       value="{{ item.producto }}"
                       class="form-control form-control-sm">

                {% if item.suggest %}
                <div class="mt-1">
                  {% for s in item.suggest %}
                  <button type="button" class="btn btn-xs btn-outline-secondary"
                    onclick="setSku({{ forloop.parentloop.counter0 }}, '{{ s.2|escapejs }}')">
                    {{ s.2 }}
                  </button>
                  {% endfor %}
                </div>
                {% endif %}
              </td>

              <td>
                <input type="number" step="0.01"
                       name="item_{{ forloop.counter0 }}_precio"
                       value="{{ item.precio_unitario }}"
                       class="form-control form-control-sm text-end"
                       id="prec_{{ forloop.counter0 }}"
                       oninput="calcularFila({{ forloop.counter0 }})">
              </td>

              <td class="text-end fw-bold">
                <span id="subtotal_{{ forloop.counter0 }}">{{ item.subtotal }}</span>
              </td>

              <td>
                <input type="text"
                       name="item_{{ forloop.counter0 }}_catalogo_sku"
                       id="sku_{{ forloop.counter0 }}"
                       list="catalogoProductos"
                       class="form-control form-control-sm"
                       placeholder="Buscar SKU…">

                <div class="d-flex gap-2 mt-2">
                  <label class="form-check small">
                    <input class="form-check-input bulk-upd-stock"
                           type="checkbox"
                           name="item_{{ forloop.counter0 }}_upd_stock" checked>
                    Stock
                  </label>

                  <label class="form-check small">
                    <input class="form-check-input bulk-upd-costo"
                           type="checkbox"
                           name="item_{{ forloop.counter0 }}_upd_precio">
                    Costo
                  </label>

                  <label class="form-check small">
                    <input class="form-check-input bulk-crear"
                           type="checkbox"
                           name="item_{{ forloop.counter0 }}_crear_si_no_existe">
                    Crear
                  </label>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>

          <tfoot class="table-light">
            <tr>
              <td colspan="4" class="text-end fw-bold">Total:</td>
              <td class="text-end fw-bold">
                $<span id="totalGeneral">0.00</span>
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card-footer text-end">
        <button type="submit" class="btn btn-success">
          Confirmar y guardar
        </button>
      </div>
    </div>

    <!-- ================= PREVIEW ABAJO ================= -->
    <div class="card shadow-sm">
      <div class="card-header bg-dark text-white d-flex justify-content-between">
        <span>Preview de la factura</span>
        <button class="btn btn-sm btn-outline-light"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#previewFactura"
                onclick="this.textContent = this.textContent==='Mostrar'?'Ocultar':'Mostrar'">
          Mostrar
        </button>
      </div>

      <div id="previewFactura" class="collapse">
        <div class="card-body p-0">
          {% if factura_url %}
            <embed src="{{ factura_url }}" width="100%" height="700px">
          {% else %}
            <div class="p-4 text-muted text-center">
              No hay PDF (texto manual)
            </div>
          {% endif %}
        </div>
      </div>
    </div>

  </form>

  {% endif %}
</div>

<script>
function bulkSet(selector, checked) {
  document.querySelectorAll(selector).forEach(el => {
    el.checked = checked;
    if (selector === '.bulk-item-check') {
      el.dispatchEvent(new Event('change'));
    }
  });
}

function setSku(index, sku) {
  const i = document.getElementById(`sku_${index}`);
  if (i) i.value = sku;
}

function toggleRowVisibility(index) {
  const cb = document.getElementById(`check_${index}`);
  const row = document.getElementById(`row_${index}`);
  row.style.opacity = cb.checked ? '1' : '0.4';
  actualizarTotalGeneral();
}

function calcularFila(index) {
  const c = parseFloat(document.getElementById(`cant_${index}`).value) || 0;
  const p = parseFloat(document.getElementById(`prec_${index}`).value) || 0;
  document.getElementById(`subtotal_${index}`).textContent = (c*p).toFixed(2);
  actualizarTotalGeneral();
}

function actualizarTotalGeneral() {
  let t = 0;
  document.querySelectorAll('.item-check:checked').forEach(cb => {
    const i = cb.id.split('_')[1];
    t += parseFloat(document.getElementById(`subtotal_${i}`).textContent) || 0;
  });
  document.getElementById('totalGeneral').textContent = t.toFixed(2);
}

document.addEventListener('DOMContentLoaded', actualizarTotalGeneral);
</script>

{% endblock %}
